---
title: "Cortical Myeloarchitecture Supports Mature Cortical Dynamics"
author: "Valerie Jill Sydnor"
output: 
  rmdformats::material:
    highlight: monochrome
    lightbox: true
    gallery: true
    css: /Volumes/Hera/Projects/corticalmyelin_development/code/corticalmyelin_maturation/results/custom_css/eeg.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(eegkit)
library(dplyr)
library(conflicted)
conflict_prefer("filter", "dplyr")
library(tidyr)
library(ggplot2)
library(ggseg)
library(ggsegGlasser)
library(ggcorrplot)
library(cifti)
library(purrr)
library(scales)
library(ggnewscale)
library(arrow)
library(kableExtra)
library(mgcv)
library(ggeffects)
extrafont::loadfonts()
source("/Volumes/Hera/Projects/corticalmyelin_development/code/corticalmyelin_maturation/gam_models/gam_functions.R")
```

# Read in Data

R1 and aperiodic measures in electrode atlas

```{r}
#Depth-specific (superficial/deep) R1 and fooof measures for final study sample
R1_aperiodicactivity_electrodeatlas <- readRDS("/Volumes/Hera/Projects/corticalmyelin_development/EEG/R1_aperiodicactivity_electrodeatlas.RDS") #generated by /image_processing/EEG_aperiodic/fooof_aperiodicactivity.R
R1_aperiodicactivity_electrodeatlas <- lapply(R1_aperiodicactivity_electrodeatlas, function(depth){
  depth$subject_id <- as.factor(depth$subject_id) #factor for gam modeling
  return(depth)
})

#Long depth df for interaction plotting
SGIGR1_aperiodicactivity_electrodeatlas <- do.call(rbind, R1_aperiodicactivity_electrodeatlas)
SGIGR1_aperiodicactivity_electrodeatlas$depth <- factor(sub("\\..*$", "", row.names(SGIGR1_aperiodicactivity_electrodeatlas)), levels = c("deep", "superficial"), ordered = T) #ordered factor for interactions, depth is the base smooth and superficial is the interaction difference smooth

fooof.data <- R1_aperiodicactivity_electrodeatlas[[1]] #for aperiodic activity developmental models 
```

R1 - aperiodic activity gam outputs

```{r}
setwd("/Volumes/Hera/Projects/corticalmyelin_development/gam_outputs/eeg_associations/") #output from /gam_models/fit_eegGAMS_electrodeatlas_bydepth.R

files <- list.files(getwd()) 

#read in files and assign to variables
for(i in 1:length(files)){
  
  Rfilename <- gsub(".RDS", "", files[i])
  
  x <- readRDS(files[i]) 
  assign(Rfilename, x) 
  }
```

# EEG cortical zones

```{r}
eegkit::eegcap(electrodes = c("F7", "F8", #vlpfc
"AF5", "AF6", "F3", "F4", "F5", "F6",     #dlpfc
"AF1", "AF2", "F1", "F2",                 #superior pfc
"FC1", "FC2", "FC3", "FC4"),              #motor
col.point = c("#B5ABCE", "#B5ABCE",
"#61568f", "#61568f", "#61568f", "#61568f", "#61568f", "#61568f",
"#275887", "#275887", "#275887", "#275887",
"#96bfd6", "#96bfd6", "#96bfd6", "#96bfd6"),
cex.point = 3, nose = TRUE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey",
type="2d")
```

```{r include=FALSE}
pdf("/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6/Electrodes_eegcap_all.pdf", width = 1.5, height = 1)

eegkit::eegcap(electrodes = c("F7", "F8", #vlpfc
"AF5", "AF6", "F3", "F4", "F5", "F6",     #dlpfc
"AF1", "AF2", "F1", "F2",                 #superior pfc
"FC1", "FC2", "FC3", "FC4"),              #motor
col.point = c("#B5ABCE", "#B5ABCE",
"#61568f", "#61568f", "#61568f", "#61568f", "#61568f", "#61568f",
"#275887", "#275887", "#275887", "#275887",
"#96bfd6", "#96bfd6", "#96bfd6", "#96bfd6"),
cex.point = .4, nose = TRUE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey",
type="2d")

dev.off()
```

# Aperiodic Slope Flattens Through Adolescence

```{r}
#Aperiodic exponent developmental gams for the four EEG cortical zones
vlpfc.exponent.gam <- gam.statistics.smooths(input.df = fooof.data, region = "vlpfc_exponent", smooth_var = "age", id_var = "subject_id", covariates = "NA", random_intercepts = TRUE, random_slopes = FALSE, knots = 3, set_fx = FALSE)

dlpfc.exponent.gam <- gam.statistics.smooths(input.df = fooof.data, region = "dlpfc_exponent", smooth_var = "age", id_var = "subject_id", covariates = "NA", random_intercepts = TRUE, random_slopes = FALSE, knots = 3, set_fx = FALSE)

spfc.exponent.gam <- gam.statistics.smooths(input.df = fooof.data, region = "spfc_exponent", smooth_var = "age", id_var = "subject_id", covariates = "NA", random_intercepts = TRUE, random_slopes = FALSE, knots = 3, set_fx = FALSE)

motor.exponent.gam <- gam.statistics.smooths(input.df = fooof.data, region = "motor_exponent", smooth_var = "age", id_var = "subject_id", covariates = "NA", random_intercepts = TRUE, random_slopes = FALSE, knots = 3, set_fx = FALSE)

exponent.gam.stats <- rbind(vlpfc.exponent.gam$gam.statistics, dlpfc.exponent.gam$gam.statistics, spfc.exponent.gam$gam.statistics, motor.exponent.gam$gam.statistics)
```

## Developmental statistics

```{r}
exponent.gam.stats %>% select(orig_parcelname, GAM.smooth.Fvalue, GAM.smooth.pvalue, smooth.decrease.offset) %>%
kbl() %>% kable_classic(full_width = F)
```

## Developmental trajectories

```{r, warning = F}
ggplot() +
  #raw data
    geom_point(data = fooof.data, aes(x = age, y = vlpfc_exponent, group = subject_id), color = "black", size = .3, shape = 16) +
    geom_line(data = fooof.data, aes(x = age, y = vlpfc_exponent, group = subject_id), linewidth = 0.2, color = "gray77") +
    geom_point(data = fooof.data, aes(x = age, y = dlpfc_exponent, group = subject_id), color = "black", size = .3, shape = 16) +
    geom_line(data = fooof.data, aes(x = age, y = dlpfc_exponent, group = subject_id), linewidth = 0.2, color = "gray77") +
    geom_point(data = fooof.data, aes(x = age, y = spfc_exponent, group = subject_id), color = "black", size = .3, shape = 16) +
    geom_line(data = fooof.data, aes(x = age, y = spfc_exponent, group = subject_id), linewidth = 0.2, color = "gray77") +
   geom_point(data = fooof.data, aes(x = age, y = motor_exponent, group = subject_id), color = "black", size = .3, shape = 16) +
   geom_line(data = fooof.data, aes(x = age, y = motor_exponent, group = subject_id), linewidth = 0.2, color = "gray77") +

  #fitted smooths
      geom_line(data = vlpfc.exponent.gam$gam.fittedvalues, aes(x = age, y = fitted), color = "#B5ABCE", linewidth = .8) +
      geom_line(data = dlpfc.exponent.gam$gam.fittedvalues, aes(x = age, y = fitted), color = "#61568f", linewidth = .8) +
      geom_line(data = spfc.exponent.gam$gam.fittedvalues, aes(x = age, y = fitted), color = "#275887", linewidth = .8) +
      geom_line(data = motor.exponent.gam$gam.fittedvalues, aes(x = age, y = fitted), color = "#79acc9", linewidth = .8) +
    labs(x="\nAge", y=sprintf("Aperiodic Exponent\n")) +
    scale_y_continuous(limits = c(0.66, 2.05)) + 
    theme_classic() +
    theme(
        legend.position = "none", 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 6, family = "Arial", color = c("black")),
        axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
        axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
        axis.line = element_line(linewidth = .2), 
        axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6/Exponent_agesmooths.pdf", device = "pdf", dpi = 500, width = 2.37, height = 1.95)
```

# Deep Cortex Myelin Content Influences an E/I-linked Measure of Cortical Synchrony 

## Superficial cortex R1 - aperiodic exponent associations

```{r}
R1exponent_superficial_maineffect$gam.statistics.df$depth <- "superficial"
R1exponent_superficial_maineffect$gam.statistics.df
```

## Deep cortex R1 - aperiodic exponent associations

```{r}
R1exponent_deep_maineffect$gam.statistics.df$depth <- "deep"
R1exponent_deep_maineffect$gam.statistics.df
```

```{r}
R1exponent.plotdata <- rbind(R1exponent_superficial_maineffect$gam.statistics.df, R1exponent_deep_maineffect$gam.statistics.df) #long df with stats per superficial and deep depths
R1exponent.plotdata$orig_parcelname <- gsub("_R1", "", R1exponent.plotdata$orig_parcelname)
R1exponent.plotdata <- R1exponent.plotdata %>% filter(orig_parcelname != "motor")
R1exponent.plotdata$orig_parcelname <- factor(R1exponent.plotdata$orig_parcelname, ordered = T, levels = c("vlpfc", "dlpfc", "spfc")) #order for plotting

ggplot(R1exponent.plotdata, aes (x = orig_parcelname, y = GAM.covsmooth.meaneffect, group = depth, color = depth)) +
  geom_point(size = 3.5, shape = 15) + 
  theme_classic() +
  scale_x_discrete(expand = c(.1, .1)) +
  scale_y_continuous(limits = c(-0.01864, -0.0065), breaks = c(-0.018, -0.015, -0.012, -0.009)) +
  scale_color_manual(values = c("#004A38FF", "#A29DC4")) +
  labs(x="\n", y=sprintf("R1 - Aperiodic Exponent Association\nEffect Size (derivative)\n")) +
  theme(
        legend.position = "none", 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 6, family = "Arial", color = c("black")),
        axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
        axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
        axis.line = element_line(linewidth = .2), 
        axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6/R1Exponent_meanderivative_effectplot.pdf", device = "pdf", dpi = 500, width = 2.1, height = 1.94)
```

## R1 - aperiodic exponent interactions by cortical depth

```{r}
R1exponent_depth_interaction %>% kbl() %>% kable_classic(full_width = F)
```

```{r, message = F}
vlpfc.interaction.model <- gam(vlpfc_R1 ~ s(age, k = 4, fx = F) + s(vlpfc_exponent, k = 3, fx = F) + s(vlpfc_exponent, by = depth, k = 3) + s(subject_id, bs="re") + depth, method = c("REML"), data = SGIGR1_aperiodicactivity_electrodeatlas) 

interaction.plotdata <- ggpredict(vlpfc.interaction.model, terms = c("vlpfc_exponent", "depth"), interval = "confidence")
plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#A29DC4"), line_size = 1, dot_size = 1, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic Exponent", y=sprintf("R1 (adjusted)\n")) +
  scale_x_continuous(breaks = c(0.5, 1, 1.5)) +
  scale_y_continuous(breaks = c(0.52, 0.54, 0.56, 0.58)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6/VLPFC_R1exponent_depthinteraction.pdf", device = "pdf", dpi = 500, width = 2, height = 1.95)
```

```{r, message = F}
dlpfc.interaction.model <- gam(dlpfc_R1 ~ s(age, k = 4, fx = F) + s(dlpfc_exponent, k = 3, fx = F) + s(dlpfc_exponent, by = depth, k = 3) + s(subject_id, bs="re") + depth, method = c("REML"), data = SGIGR1_aperiodicactivity_electrodeatlas)

interaction.plotdata <- ggpredict(dlpfc.interaction.model, terms = c("dlpfc_exponent", "depth"), interval = "confidence")
plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#A29DC4"), line_size = 1, dot_size = 1, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic Exponent", y=sprintf("R1 (adjusted)\n")) +
  scale_x_continuous(breaks = c(1, 1.5, 2)) +
  scale_y_continuous(breaks = c(0.5, 0.54, 0.58)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6/DLPFC_R1exponent_depthinteraction.pdf", device = "pdf", dpi = 500, width = 2, height = 1.95)
```

```{r, message = F}
spfc.interaction.model <- gam(spfc_R1 ~ s(age, k = 4, fx = F) + s(spfc_exponent, k = 3, fx = F) + s(spfc_exponent, by = depth, k = 3) + s(subject_id, bs="re") + depth, method = c("REML"), data = SGIGR1_aperiodicactivity_electrodeatlas) 

interaction.plotdata <- ggpredict(spfc.interaction.model, terms = c("spfc_exponent", "depth"), interval = "confidence")
plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#A29DC4"), line_size = 1, dot_size = 1, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic Exponent", y=sprintf("R1 (adjusted)\n")) +
  scale_x_continuous(breaks = c(1, 1.5, 2)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))
```

 
# No Association Between Myelin Content and Aperiodic Offset

## Superficial cortex R1 - aperiodic offset associations

```{r}
R1offset_superficial_maineffect$gam.statistics.df %>% kbl() %>% kable_classic(full_width = F)
```

## Deep cortex R1 - aperiodic offset associations

```{r}
R1offset_deep_maineffect$gam.statistics.df %>% kbl() %>% kable_classic(full_width = F)
```



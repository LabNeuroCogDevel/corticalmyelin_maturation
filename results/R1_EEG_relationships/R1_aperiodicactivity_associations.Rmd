---
title: "Cortical Myeloarchitecture Supports E/I-Linked Neural Dynamics"
output: 
  rmdformats::material:
    highlight: monochrome
    lightbox: true
    gallery: true
    css: /Users/valeriesydnor/Documents/Image_Processing/corticalmyelin_development/code/corticalmyelin_maturation/results/custom_css/eeg.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(eegkit)
library(conflicted)
conflict_prefer("filter", "dplyr")
library(tidyr)
library(ggplot2)
library(ggseg)
library(ggsegGlasser)
library(purrr)
library(scales)
library(ggnewscale)
library(kableExtra)
library(mgcv)
library(ggeffects)
extrafont::loadfonts()
knitr::opts_knit$set(root.dir = "/Users/valeriesydnor/Documents/Image_Processing/corticalmyelin_development")
setwd("/Users/valeriesydnor/Documents/Image_Processing/corticalmyelin_development")
source("./code/corticalmyelin_maturation/gam_models/gam_functions.R")
```

# Read in Data 

Glasser regions

```{r}
#Glasser region and label names
glasser.regions <- read.csv("./Maps/HCPMMP_glasseratlas/glasser360_regionlist.csv") #whole cortex 
glasser.frontal <- read.csv("./Maps/HCPMMP_glasseratlas/glasser360_regionlist_frontallobe.csv") #frontal lobe only
glasser.snr.exclude <- read.csv("./Maps/SNR/glasser_SNR_exclusion.csv") #SNR exclusion parcels
```

```{r}
#for ggseg brain colors
glasser.plotting <- glasser.regions
glasser.plotting$cortex <- "cortex"
glasser.plotting$cortex[glasser.plotting$orig_parcelname %in% glasser.snr.exclude$orig_parcelname] <- "exclude"
glasser.plotting <- glasser.plotting %>% select(label, cortex)
glasser.plotting <- rbind(glasser.plotting, data.frame(label = "rh_???", cortex = "exclude"))
glasser.plotting <- rbind(glasser.plotting, data.frame(label = "lh_???", cortex = "exclude"))
glasser.plotting <- glasser.plotting %>% filter(label != "lh_L_10pp")
```

Final participant list

```{r}
participants <- read.csv("./sample_info/7T_MP2RAGE_finalsample_demographics.csv")
participants <- participants %>% mutate(subses = sprintf("%s_%s", sub("^sub-", "", subject_id), sub("^ses-", "", session_id)))
```

Power spectra

```{r}
power.data <- readRDS("./EEG/PSD_table.RDS")
power.data$lunaid <- gsub("11665", "11390", power.data$lunaid) #update subject id to match MRI
power.data$lunaid <- gsub("11748", "11515", power.data$lunaid) #update subject id to match MRI
```

EEG aperiodic exponent in glasser regions

```{r}
EEG.exponent <- readRDS("./EEG/aperiodicexponent_glasseratlas_finalsample.RDS")
EEG.exponent <- EEG.exponent %>% select(-matches(paste(glasser.snr.exclude$orig_parcelname, collapse = "|")))
```

Superficial and deep R1 measures

```{r}
myelin.compartments.7T <- readRDS("./BIDS/derivatives/surface_metrics/compartmentsR1_glasseratlas_finalsample.RDS") 

myelin.superficial.deep.7T <- do.call(rbind, myelin.compartments.7T)
myelin.superficial.deep.7T <- myelin.superficial.deep.7T %>% mutate(depth = factor(str_remove(row.names(myelin.superficial.deep.7T), "\\..*")))
myelin.superficial.deep.7T <- myelin.superficial.deep.7T %>% filter(depth != "middle")
myelin.superficial.deep.7T$depth <- factor(myelin.superficial.deep.7T$depth, levels = c("deep", "superficial"), ordered = T)
```

```{r}
myelin.superficial.deep.7T <- myelin.superficial.deep.7T %>% mutate(subses = sprintf("%s_%s", sub("^sub-", "", subject_id), sub("^ses-", "", session_id))) #update subses variable to match to EEG data format 
myelin.superficial.deep.7T <- left_join(myelin.superficial.deep.7T, EEG.exponent, by = "subses")
myelin.superficial.deep.7T$subject_id <- as.factor(myelin.superficial.deep.7T$subject_id)
```

GAM outupts: aperiodic activity

```{r}
EEG.gams <- readRDS("./gam_outputs/eeg_associations/R1exponent_depth_interaction_glasser.RDS") #generated by gam_models/fit_EEGGAMs_glasserregions_bydepth.R

EEG.gams.deepeffects <- merge(EEG.gams$gam.baseeffects.df, glasser.frontal) #R1-exponent association modeled with deep cortex R1
EEG.gams.deepeffects <- EEG.gams.deepeffects[!(EEG.gams.deepeffects$orig_parcelname %in% glasser.snr.exclude$orig_parcelname),]

EEG.gams.interaction <- merge(EEG.gams$gam.interactions.df, glasser.frontal) #superficial compared to deep interaction 
EEG.gams.interaction <- EEG.gams.interaction[!(EEG.gams.interaction$orig_parcelname %in% glasser.snr.exclude$orig_parcelname),]
```

# Frontal Cortex Aperiodic Exponent in Youth

## 64 channel EEG cap

```{r}
eegkit::eegcap(electrodes = c(unique(power.data$labels)),
cex.point = 1.5, nose = FALSE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey", col.point = "#6b9797", 
type="2d")

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/EEGcap_64channel.pdf", device = "pdf", dpi = 500, width = 2.5, height = 1.67)
```

```{r, include = F}
pdf("/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/EEGcap_64channel.pdf", width = 1.8, height = 1.5)


eegkit::eegcap(electrodes = c(unique(power.data$labels)),
cex.point = .7, nose = FALSE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey", col.point = "#6b9797", 
type="2d")

dev.off()
```

## Power spectrums stratified by age

```{r}
frontal.electrodes <- c("AF1", "AF2", "AF5", "AF6", "AFz", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "FC1", "FC2", "FC3", "FC4", "FCz", "Fp1",  "Fp2", "Fz")
power.data <- power.data[power.data$labels %in% frontal.electrodes,]
power.data <- power.data %>% filter(freqs > 5) %>% filter(freqs < 50)
power.data <- merge(power.data, participants, by = c("lunaid", "eeg.date"))
```

```{r}
#Age bin averaged power spectra
power.young <- power.data %>% filter(age <= 15) %>% group_by(freqs) %>% do(power = mean(.$power)) %>% unnest(cols = "power")

power.old <- power.data %>% filter(age >= 25) %>% filter(age <= 30) %>% group_by(freqs) %>% do(power = mean(.$power)) %>% unnest(cols = "power")
```

```{r}
ggplot() +
  geom_line(data = power.young, aes(x = freqs, y = log10(power)), color = "#477273", linewidth = 0.8) +
  geom_line(data = power.old, aes(x = freqs, y = log10(power)), color = "#a2c2c2", linewidth = 0.8) + 
  theme_classic() +
  labs(x="\nFrequency", y=sprintf("Power (log)\n")) +
  theme(
        legend.position = "none", 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 6, family = "Arial", color = c("black")),
        axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
        axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
        axis.line = element_line(linewidth = .2), 
        axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Powerspectrum_agebinned.pdf", device = "pdf", dpi = 500, width = 2.2, height = 1.6)
```

## Aperiodic exponent varies across the frontal cortex

```{r}
frontal.exponent.sample <- EEG.exponent %>% select(contains("exponent")) %>% colMeans() %>% as.data.frame() %>% set_names("exponent") %>% mutate(orig_parcelname = gsub("_exponent", "", row.names(.))) %>% merge(., glasser.frontal)
```

```{r, message = F}
frontal.exponent.sample %>% filter(label != "lh_L_10pp") %>%
ggplot(data = .) + 
  geom_brain(atlas = glasser, mapping = aes(fill = exponent), colour=I("gray20"), size=I(.08)) + theme_classic()  + 
  scale_fill_gradient2(low = "white", mid = "#70abab", high =  "#387373", limits = c(1, 1.3), midpoint = 1.15, oob = squish, na.value = "white") +
  theme(legend.position = "none", axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank()) +
  new_scale_fill() + 
  geom_brain(data = glasser.plotting, atlas = glasser, mapping = aes(fill = cortex),  colour=I(alpha("gray20", 0)), size=I(0)) +
  scale_fill_manual(values = c(alpha("white", 0), "gray75")) 

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Aperiodicexponent_corticalmap.pdf", device = "pdf", dpi = 500, width = 4.5, height = 3.5)
```

## Developmental change in frontal cortex aperiodic exponent

Developmental GAMM

```{r}
EEG.exponent.long <- EEG.exponent %>% pivot_longer(cols = contains("exponent"), names_to = "orig_parcelname", values_to = "exponent")

frontal.exponent.individual <- EEG.exponent.long %>% group_by(subses) %>% do(exponent = mean(.$exponent)) %>% unnest(cols = c("exponent")) #average exponent in frontal lobe for each sub/session
frontal.exponent.individual <- merge(frontal.exponent.individual, participants)
frontal.exponent.individual$subject_id <- as.factor(frontal.exponent.individual$subject_id)
```

```{r}
frontal.exponent.gamresults <- gam.statistics.smooths(input.df = frontal.exponent.individual, region = "exponent", smooth_var = "age", id_var = "subject_id", covariates = "NA", random_intercepts = TRUE, random_slopes = FALSE, knots = 4, set_fx = FALSE)

frontal.exponent.gamresults$gam.statistics %>% select(GAM.smooth.Fvalue, GAM.smooth.pvalue, smooth.decrease.onset, smooth.decrease.offset) %>%
kbl() %>% kable_classic(full_width = F) 
```

Developmental trajectory 

```{r}
ggplot() +
  geom_point(data = frontal.exponent.individual, aes(x = age, y = exponent), color = "black", size = .3, shape = 16) +
  geom_line(data = frontal.exponent.individual, aes(x = age, y = exponent, group = subject_id), linewidth = 0.2, color = "gray77") +
  geom_line(data = frontal.exponent.gamresults$gam.fittedvalues, aes(x = age, y = fitted), color = "#387373", linewidth = .8) +
  labs(x="\nAge (years)", y=sprintf("Aperiodic exponent\n")) +
  scale_y_continuous(limits = c(0.2, 1.85)) + 
  theme_classic() +
  theme(
        legend.position = "none", 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 6, family = "Arial", color = c("black")),
        axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
        axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
        axis.line = element_line(linewidth = .2), 
        axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Aperiodicexponent_development.pdf", device = "pdf", dpi = 500, width = 2, height = 1.6)
```

# R1 - Aperiodic Exponent Associations

## Deep compartment

Regions with significant associations between exponent and deep cortex R1

```{r}
EEG.gams.deepeffects <- EEG.gams.deepeffects %>% mutate(significant = p.adjust(EEG.gams.deepeffects$`p-value`, method = "fdr") < 0.05)
EEG.gams.deepeffects.significant <- EEG.gams.deepeffects %>% filter(significant == TRUE)

sprintf("There is a significant relationship between the aperiodic exponent and deep cortex R1 in %s regions", sum(EEG.gams.deepeffects$significant))
```


```{r, message = F}
EEG.gams.deepeffects %>% filter(label != "lh_L_10pp") %>%
ggplot(data = .) + 
  geom_brain(atlas = glasser, mapping = aes(fill = significant), colour=I("gray20"), size=I(.08)) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = c("white", "#004A38FF"), na.value = "white") +
  theme(legend.position = "none", axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank()) +
  new_scale_fill() + 
  geom_brain(data = glasser.plotting, atlas = glasser, mapping = aes(fill = cortex),  colour=I(alpha("gray20", 0)), size=I(0)) +
  scale_fill_manual(values = c(alpha("white", 0), "gray75")) 

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/DeepR1_exponent_significancemap.pdf", device = "pdf", dpi = 500, width = 4.5, height = 3.5)
```


## Depth interactions

Regions with significant depth interaction (R1-exponent relationship differs by depth)

```{r}
EEG.gams.interaction <- EEG.gams.interaction[EEG.gams.interaction$orig_parcelname %in% EEG.gams.deepeffects.significant$orig_parcelname,] #check for depth interactions within significant regions 

EEG.gams.interaction <- EEG.gams.interaction %>% mutate(significant = p.adjust(EEG.gams.interaction$`p-value`, method = "fdr") < 0.05)

sprintf("There is a significant depth interaction in %s of %s regions with a significant main effect (%s percent)", sum(EEG.gams.interaction$significant), sum(EEG.gams.deepeffects$significant), 
round(sum(EEG.gams.interaction$significant)/sum(EEG.gams.deepeffects$significant), 4)*100)
```

```{r, message = F}
EEG.gams.interaction %>% filter(label != "lh_L_10pp") %>%
ggplot(data = .) + 
  geom_brain(atlas = glasser, mapping = aes(fill = significant), colour=I("gray20"), size=I(.08)) + theme_classic() + theme(legend.position = "none") + 
  scale_fill_manual(values = c("white", "#7aa5a6"), na.value = "white") +
  theme(legend.position = "none", axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank()) +
  new_scale_fill() + 
  geom_brain(data = glasser.plotting, atlas = glasser, mapping = aes(fill = cortex),  colour=I(alpha("gray20", 0)), size=I(0)) +
  scale_fill_manual(values = c(alpha("white", 0), "gray75")) 

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Depthinteraction_exponent_significancemap.pdf", device = "pdf", dpi = 500, width = 4.5, height = 3.5)
```

Interaction plots

```{r, warning = F, message = F}
area4.interaction.model <- gam(L_4_ROI ~ s(age, k = 4, fx = F) + s(L_4_ROI_exponent, k = 3, fx = F) + s(L_4_ROI_exponent, by = depth, k = 3, fx = F) + s(subject_id, bs="re") + depth, method = c("REML"), data = myelin.superficial.deep.7T) 

summary(area4.interaction.model)
```

```{r, warning = F, message = F}
interaction.plotdata <- ggpredict(area4.interaction.model, terms = c("L_4_ROI_exponent", "depth"), interval = "confidence")

plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#8987af"), line_size = 1, dot_size = .8, dot_alpha = .6, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic exponent", y=sprintf("R1 (partial residuals)\n")) +
  scale_x_continuous(breaks = c(0.5, 1, 1.5)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Depthinteraction_Area4.pdf", device = "pdf", dpi = 500, width = 2, height = 1.9)
```

```{r, warning = F, message = F}
area46.interaction.model <- gam(L_46_ROI ~ s(age, k = 4, fx = F) + s(L_46_ROI_exponent, k = 3, fx = F) + s(L_46_ROI_exponent, by = depth, k = 3, fx = F) + s(subject_id, bs="re") + depth, method = c("REML"), data = myelin.superficial.deep.7T) 

summary(area46.interaction.model)
```

```{r, warning = F, message = F}
interaction.plotdata <- ggpredict(area46.interaction.model, terms = c("L_46_ROI_exponent", "depth"), interval = "confidence")

plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#8987af"), line_size = 1, dot_size = .8, dot_alpha = .6, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic exponent", y=sprintf("R1 (partial residuals)\n")) +
  scale_x_continuous(breaks = c(0.5, 1, 1.5)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Depthinteraction_Area46.pdf", device = "pdf", dpi = 500, width = 2, height = 1.9)
```

```{r, warning = F, message = F}
areaa24.interaction.model <- gam(R_a24_ROI ~ s(age, k = 4, fx = F) + s(R_a24_ROI_exponent, k = 3, fx = F) + s(R_a24_ROI_exponent, by = depth, k = 3, fx = F) + s(subject_id, bs="re") + depth, method = c("REML"), data = myelin.superficial.deep.7T) 

summary(areaa24.interaction.model)
```

```{r, warning = F, message = F}
interaction.plotdata <- ggpredict(areaa24.interaction.model, terms = c("R_a24_ROI_exponent", "depth"), interval = "confidence")

plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#8987af"), line_size = 1, dot_size = .8, dot_alpha = .6, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic exponent", y=sprintf("R1 (partial residuals)\n")) +
  scale_x_continuous(breaks = c(0.5, 1, 1.5)) +
  scale_y_continuous(breaks = c(0.49, 0.53, 0.57)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Users/valeriesydnor/Documents/ResearchProjects/CorticalMyelin_PlasticityDevelopment/Publications/Publication_Images/Figure7/Depthinteraction_Areaa24.pdf", device = "pdf", dpi = 500, width = 2, height = 1.9)
```





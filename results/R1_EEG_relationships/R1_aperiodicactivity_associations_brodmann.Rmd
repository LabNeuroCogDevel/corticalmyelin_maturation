---
title: "Cortical Myeloarchitecture Supports Mature Cortical Dynamics (Sensitivity Analysis)"
author: "Valerie Jill Sydnor"
output: 
  rmdformats::material:
    highlight: monochrome
    lightbox: true
    gallery: true
    css: /Volumes/Hera/Projects/corticalmyelin_development/code/corticalmyelin_maturation/results/custom_css/eeg.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(eegkit)
library(dplyr)
library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
library(tidyr)
library(ggplot2)
library(ggseg)
library(ggsegGlasser)
library(ggcorrplot)
library(cifti)
library(purrr)
library(scales)
library(ggnewscale)
library(arrow)
library(kableExtra)
library(mgcv)
library(ggeffects)
library(ggsegBrodmann)
extrafont::loadfonts()
source("/Volumes/Hera/Projects/corticalmyelin_development/code/corticalmyelin_maturation/gam_models/gam_functions.R")
```

# Read in Data

R1 and aperiodic measures in Brodmann atlas

```{r}
#Depth-specific (superficial/deep) R1 and fooof measures for final study sample
R1_aperiodicactivity_electrodeatlas_brodmann <- readRDS("/Volumes/Hera/Projects/corticalmyelin_development/EEG/R1_aperiodicactivity_brodmann.RDS") #generated by /image_processing/EEG_aperiodic/fooof_aperiodicactivity_brodmann.R
R1_aperiodicactivity_electrodeatlas_brodmann <- lapply(R1_aperiodicactivity_electrodeatlas_brodmann, function(depth){
  depth$subject_id <- as.factor(depth$subject_id) #factor for gam modeling
  return(depth)
})

#Long depth df for interaction plotting
SGIGR1_aperiodicactivity_electrodeatlas_brodmann <- do.call(rbind, R1_aperiodicactivity_electrodeatlas_brodmann)
SGIGR1_aperiodicactivity_electrodeatlas_brodmann$depth <- factor(sub("\\..*$", "", row.names(SGIGR1_aperiodicactivity_electrodeatlas_brodmann)), levels = c("deep", "superficial"), ordered = T)
```

R1 - aperiodic activity gam outputs

```{r, warning = F}
setwd("/Volumes/Hera/Projects/corticalmyelin_development/gam_outputs/eeg_associations/") #output from /gam_models/fit_eegGAMS_electrodeatlas_bydepth.R

files <- list.files(getwd(), pattern = "brodmann") 

#read in files and assign to variables
for(i in 1:length(files)){
  
  Rfilename <- gsub(".RDS", "", files[i])
  
  x <- readRDS(files[i]) 
  assign(Rfilename, x) 
  }
```

# EEG Cortical Zones and Brodmann Atlas

```{r}
eegkit::eegcap(electrodes = c("F7", "F8",              #BA45
"F3", "F4", "F5", "F6",                                #BA9
"F1", "F2",                                            #BA8
"FC1", "FC2", "FC3", "FC4", "FC5", "FC6", "C1", "C2"), #BA4/6
col.point = c("#c2d4ed", "#c2d4ed",
"#7a99c2", "#7a99c2", "#7a99c2", "#7a99c2",
"#345c91", "#345c91",
"#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366"),
cex.point = 3, nose = TRUE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey",
type="2d")
```

```{r include=FALSE}
pdf("/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6_supplementary/Electrodes_eegcap_brodmann.pdf", width = 1.5, height = .95)

eegkit::eegcap(electrodes = c("F7", "F8",              #BA45
"F3", "F4", "F5", "F6",                                #BA9
"F1", "F2",                                            #BA8
"FC1", "FC2", "FC3", "FC4", "FC5", "FC6", "C1", "C2"), #BA4/6
col.point = c("#c2d4ed", "#c2d4ed",
"#7a99c2", "#7a99c2", "#7a99c2", "#7a99c2",
"#345c91", "#345c91",
"#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366", "#0f3366"),
cex.point = .4, nose = TRUE, ears = TRUE,
plotlabels = FALSE,  plotaxes = FALSE, col.head = "grey",
type="2d")

dev.off()
```

```{r}
brodmann.regions <- data.frame(label = c("lh_BA45", "lh_BA9", "lh_BA8", "lh_BA6", "lh_BA4"), group = c("group1", "group2", "group3", "group4", "group4"))

ggseg(.data = brodmann.regions, atlas = "brodmann", mapping = aes(fill = group), , colour=I("gray50"), size=I(.08), hemi = "left") +
  scale_fill_manual(values = c("#c2d4ed", "#7a99c2", "#345c91", "#0f3366"), na.value = "white") +   theme(legend.position = "none")

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6_supplementary/Brodmann_atlas.pdf", device = "pdf", dpi = 500, width = 2.15, height = 1.96)
```

# Deep Cortex Myelin Impacts an E/I-Linked Measure of Functional Maturation

## Superficial cortex R1 - aperiodic exponent associations

```{r}
R1exponent_superficial_maineffect_brodmann$gam.statistics.df$depth <- "superficial"
R1exponent_superficial_maineffect_brodmann$gam.statistics.df
```

## Deep cortex R1 - aperiodic exponent associations

```{r}
R1exponent_deep_maineffect_brodmann$gam.statistics.df$depth <- "deep"
R1exponent_deep_maineffect_brodmann$gam.statistics.df
```


```{r}
R1exponent.plotdata <- rbind(R1exponent_superficial_maineffect_brodmann$gam.statistics.df, R1exponent_deep_maineffect_brodmann$gam.statistics.df) #long df with stats per superficial and deep depths
R1exponent.plotdata$orig_parcelname <- gsub("_R1", "", R1exponent.plotdata$orig_parcelname)
R1exponent.plotdata <- R1exponent.plotdata %>% filter(orig_parcelname != "Brodmann.4.6")
R1exponent.plotdata$orig_parcelname <- gsub("\\.", "\\ ", R1exponent.plotdata$orig_parcelname)
R1exponent.plotdata$orig_parcelname <- factor(R1exponent.plotdata$orig_parcelname, ordered = T, levels = c("Brodmann 45", "Brodmann 9", "Brodmann 8")) #order for plotting

ggplot(R1exponent.plotdata, aes (x = orig_parcelname, y = GAM.covsmooth.Fvalue, group = depth, color = depth)) +
  geom_point(size = 3.5, shape = 15) + 
  theme_classic() +
  scale_x_discrete(expand = c(.1, .1)) +
  scale_y_continuous(breaks = c(2, 3, 4)) +
  scale_color_manual(values = c("#004A38FF", "#A29DC4")) +
  labs(x="\n", y=sprintf("R1 - Aperiodic Exponent Association\nEffect Size (derivative)\n")) +
  theme(
        legend.position = "none", 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 6, family = "Arial", color = c("black")),
        axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
        axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
        axis.line = element_line(linewidth = .2), 
        axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6_supplementary/R1Exponent_meanderivative_effectplot.pdf", device = "pdf", dpi = 500, width = 2.3, height = 1.94)
```


## R1 - aperiodic exponent interactions by cortical depth

#### Interaction effects

```{r}
R1exponent_depth_interaction_brodmann$gam.interactions.df %>% kbl() %>% kable_classic(full_width = F)
```

```{r, message = F}
BA45.interaction.model <- gam(Brodmann.45_R1 ~ s(age, k = 4, fx = F) + s(Brodmann.45_exponent, k = 3, fx = F) + s(Brodmann.45_exponent, by = depth, k = 3) + s(subject_id, bs="re") + depth, method = c("REML"), data = SGIGR1_aperiodicactivity_electrodeatlas_brodmann) 

interaction.plotdata <- ggpredict(BA45.interaction.model, terms = c("Brodmann.45_exponent", "depth"), interval = "confidence")
plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#A29DC4"), line_size = 1, dot_size = 1, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic Exponent", y=sprintf("R1 (adjusted)\n")) +
  scale_x_continuous(breaks = c(0.5, 1, 1.5)) +
  scale_y_continuous(breaks = c(0.5, 0.54, 0.58)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6_supplementary/BA45_R1exponent_depthinteraction.pdf", device = "pdf", dpi = 500, width = 2.16, height = 1.95)
```


```{r, message = F}
BA8.interaction.model <- gam(Brodmann.8_R1 ~ s(age, k = 4, fx = F) + s(Brodmann.8_exponent, k = 3, fx = F) + s(Brodmann.8_exponent, by = depth, k = 3) + s(subject_id, bs="re") + depth, method = c("REML"), data = SGIGR1_aperiodicactivity_electrodeatlas_brodmann) 

interaction.plotdata <- ggpredict(BA8.interaction.model, terms = c("Brodmann.8_exponent", "depth"), interval = "confidence")
plot(interaction.plotdata, show_residuals = T,  show_ci = F, colors = c("#004A38FF", "#A29DC4"), line_size = 1, dot_size = 1, show_title = F) + 
  theme_classic() +
  labs(x="\nAperiodic Exponent", y=sprintf("R1 (adjusted)\n")) +
  scale_x_continuous(breaks = c(1, 1.5, 2)) +
  scale_y_continuous(breaks = c(0.5, 0.54, 0.58)) +
  theme(
       legend.position = "none", 
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 6, family = "Arial", color = c("black")),
      axis.title.x = element_text(size = 7, family ="Arial", color = c("black")),
      axis.title.y = element_text(size = 7, family ="Arial", color = c("black")),
      axis.line = element_line(linewidth = .2), 
      axis.ticks = element_line(linewidth = .2))

ggsave(filename = "/Volumes/Hera/Projects/corticalmyelin_development/Figures/Figure6_supplementary/BA8_R1exponent_depthinteraction.pdf", device = "pdf", dpi = 500, width = 2.16, height = 1.95)
```





